
ali_keypair(){
    param <<A
subcommands:
    ls                  "ls"
    attach              "attach"
    detach              "detach"
    import              "import"
    create              "Create"
    delete|del          "delete"
A

    if [ -z "$PARAM_SUBCMD" ]; then
        ali_keypair_quick "$@"
        return
    fi

    "ali_keypair_$PARAM_SUBCMD" "$@"

}

ali_keypair_ls_format(){
    ali_table_json \
            .KeyPairFingerPrint .KeyPairName .ResourceGroupId .CreationTime .RegionId
}


ali_keypair_ls(){
    if [ ! -t 1 ]; then
        _ali_keypair_ls "$@"
    else
        _ali_keypair_ls "$@" | ali_keypair_ls_format
    fi
}

_ali_keypair_ls(){
    case "$#" in
        0)  aliyun ecs DescribeKeyPairs | jq .KeyPairs.KeyPair ;;
        1)  local regex="${1:-Provide regex pattern}"
            _ali_vpc_ls | jq "
                .[] | 
                if      .KeyPairName | test(\"$regex\")                 then .
                elif    .KeyPairFingerPrint | test(\"$regex\")         then .
                else    empty       end
            " | jq -s .
            ;;
    esac
}

ali_exactor_declare ali_ec "No such keypair found." "Multiple keypair found." .KeyPairFingerName

ali_keypair_import(){
    param <<A
options:
    #1      "keypair name"
    #2      "keypair body"
A

    local name="${1:?keypair name}"
    local body="${2}"

    if [ -z "$body" ]; then
        if [ -t 0 ]; then
            local key
            printf "%s" "Import the $HOME/.ssh/id_rsa? (Enter to continue, otherwise abort): "
            ali_read key
            case "$key" in
                "") ali_log info "Using the $HOME/.ssh/id_rsa" 
                    body="$(cat "$HOME/.ssh/id_rsa.pub")"
                    ;;
                *)  ali_log warn "Abort." ;;
            esac
        else
            body="$(cat)"
        fi
    else
        if [ "$body" = "${body#ssh-rsa }" ]; then
            if [ -f "$HOME/.ssh/$body.pub" ]; then
                body="$(cat "$HOME/.ssh/$body.pub")"
            elif [ -f "$HOME/.ssh/$body" ]; then
                body="$(cat "$HOME/.ssh/$body")"
            else
                ali_log error "Not a valid key"
                return
            fi
        fi
    fi


    aliyun ecs ImportKeyPair \
        --KeyPairName "$name" \
        --PublicKeyBody "$body"

}

ali_keypair_create(){
    param <<A
options:
    #1      "keypair name"
    #2      "filepath to save private keypair"
A

    local keypairname="${1:?Keypair name}"
    aliyun ecs CreateKeyPair --KeyPairName "${keypairname}" | jq -r .PrivateKeyBody>"${2:-"/dev/stdout"}"
}

ali_keypair_delete(){
    param <<A
options:
    #n      "keypair name list"
A

    local keypairname
    for keypairname in "$@"; do
        aliyun ecs DeleteKeyPairs --KeyPairNames "[\"${keypairname}\"]"
    done
}

ali_keypair_attach(){
    # unique in region
    local kpid 
    if ! kpid="$(ali_keypair_exactid "${1:-keypair name}")"; then
        ali_log warn "KP Not found"
    fi

    local ecid
    if ! ecid="$(ali_ec_exactid "${2:-ec-id}")"; then
        ali_log warn "EC Not found"
    fi

    aliyun ecs AttachKeyPair --KeyPairName "$kpid" --InstanceIds "$ecid"
}

ali_keypair_detach(){
    # unique in region
    local kpid 
    if ! kpid="$(ali_keypair_exactid "${1:-keypair name}")"; then
        ali_log warn "KP Not found"
    fi

    local ecid
    if ! ecid="$(ali_ec_exactid "${2:-ec-id}")"; then
        ali_log warn "EC Not found"
    fi

    aliyun ecs DetachKeyPair --KeyPairName "$kpid" --InstanceIds "$ecid"

}

# shellcheck disable=SC2120
_ali_keypair_quick_title(){
    s=$(ali_keypair_ls "$@")
    printf "%s" "$s" | ali_keypair_ls_format

    cat <<A

Commands:
    i|import        i <keypair-name> <the name of ssh-keypair under ~/.ssh/ folder, or public key body>      
    del             Format: del <part of the vpc's name or id>
    create          Format: create [ --name <vpc name> ]
    r               reload
    q               quit
    :               : <cmd> [ ... <args> ]
A
}

ali_keypair_quick(){
    if [ ! -t 1 ]; then
        ali_keypair_ls "$@"
        return
    fi

    local s
    _ali_keypair_quick_title

    local line
    while printf "ali kp> " && ali_read line; do
        eval set -- "$line"
        local cmd=$1;   shift
        case "$cmd" in
            q)  printf "\n"
                return 
                ;;
            :*) eval "$@"
                ;;
            *)  ali keypair "$cmd" "$@"
        esac

        case "$cmd" in
            r|create|del|import|i)      _ali_keypair_quick_title ;;
        esac
    done

    
}

